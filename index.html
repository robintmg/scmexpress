<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickRFP Generator</title>
    <style>
        /* --- GLOBAL LAYOUT --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #eef2f5;
            margin: 0;
            padding: 0;
            color: #333;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .no-print {
            width: 98%;
            height: 96vh;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #dcdcdc;
            display: flex;
            box-sizing: border-box;
            overflow: hidden;
        }

        /* --- 60:40 SPLIT --- */
        .left-pane {
            flex: 3;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .right-pane {
            flex: 2;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #e0e0e0;
            background-color: #f8f9fa;
            padding: 20px;
            overflow: hidden; 
        }

        /* --- MAGIC IMPORT (HIDDEN) --- */
        .magic-section {
            display: none;
            background: #e3f2fd;
            border: 1px dashed #2196f3;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            flex-shrink: 0;
        }
        .magic-header { font-weight: bold; color: #0d47a1; font-size: 11px; margin-bottom: 5px;}
        #magicInput {
            width: 100%; height: 50px; border: 1px solid #90caf9; border-radius: 4px;
            padding: 5px; font-size: 10px; font-family: monospace; resize: none;
        }

        /* --- FORM STYLES --- */
        h1 { margin: 0 0 15px 0; font-size: 18px; text-align: center; cursor: default; user-select: none; }
        
        .form-section-title {
            font-size: 11px; text-transform: uppercase; color: #888; letter-spacing: 0.5px;
            border-bottom: 1px solid #eee; padding-bottom: 2px; margin-bottom: 8px; margin-top: 5px; font-weight: 700;
        }

        .form-row { display: flex; gap: 10px; margin-bottom: 8px; }
        .input-group { display: flex; flex-direction: column; gap: 3px; flex: 1; }
        .grow-2 { flex: 2; } 
        .grow-0-5 { flex: 0.6; }

        input[type="text"], input[type="number"], input[type="date"], textarea { 
            padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; width: 100%; box-sizing: border-box; 
        }
        textarea { resize: vertical; } 
        input:focus, textarea:focus { border-color: #007bff; outline: none; }
        label { font-weight: 600; font-size: 11px; color: #555; }

        .radio-group { display: flex; gap: 10px; flex-wrap: wrap; background: #f1f3f5; padding: 8px; border-radius: 4px; width: 100%; box-sizing: border-box; }
        .radio-group label { cursor: pointer; display: flex; align-items: center; gap: 4px; font-weight: 600; font-size: 11px; margin: 0; }

        /* --- BUTTONS --- */
        .btn-container { display: flex; gap: 8px; margin-top: auto; padding-top: 10px; }
        
        button { 
            padding: 10px; cursor: pointer; border-radius: 4px; border: none; 
            font-weight: bold; font-size: 12px; transition: all 0.2s; flex: 1; 
        }
        button:active { transform: translateY(1px); }
        
        /* Button Colors */
        #addBtn { background-color: #ffc107; color: #333; box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex: 1.5; }
        #updateBtn { background-color: #007bff; color: white; display: none; flex: 1.5; } /* Hidden by default */
        
        #cancelClearBtn { background-color: #dc3545; color: white; }
        #printCurrentBtn { background-color: #17a2b8; color: white; }

        /* --- QUEUE LIST --- */
        .queue-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-shrink: 0;}
        .queue-header h4 { margin: 0; color: #333; font-size: 14px; }
        
        #queue-items-container {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            border: 1px solid #eee;
            background: white;
            border-radius: 6px;
            padding: 5px;
        }

        .queue-item {
            padding: 10px; border-bottom: 1px solid #f0f0f0; 
            display: flex; flex-direction: column; gap: 4px;
            position: relative;
        }
        .queue-item:last-child { border-bottom: none; }
        .queue-item.editing { border-left: 4px solid #007bff; background-color: #eef6fc; }

        /* Queue Layout Specifics */
        .q-header { font-weight: bold; font-size: 12px; color: #000; }
        .q-sub { font-size: 11px; color: #444; display: flex; justify-content: space-between;}
        .q-details { 
            color: #666; font-size: 10px; 
            white-space: normal; word-wrap: break-word; line-height: 1.3;
            background: #fdfdfd; padding: 4px; border-radius: 4px; border: 1px solid #f0f0f0; margin-top: 2px;
        }

        .q-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 5px; }
        .q-btn { cursor: pointer; font-weight: bold; font-size: 10px; padding: 2px 8px; border-radius: 3px; }
        .q-edit { color: #007bff; background: #ebf5ff; }
        .q-remove { color: #dc3545; background: #ffeef0; }

        .queue-controls { display: flex; gap: 8px; flex-shrink: 0; }
        #printQueueBtn { background-color: #28a745; color: white; padding: 12px;}
        #clearQueueBtn { background-color: #6c757d; color: white; flex: 0.4; }

        /* --- PRINT AREA --- */
        .action-buttons { 
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 100; display: none; 
        }
        #backBtn { background-color: #007bff; color: white; width: auto; padding: 10px 25px; }

        #print-area { display: none; }
        .hidden-on-screen { display: none !important; }

        /* --- PRINT CSS (Standard) --- */
        .print-page { width: 850px; height: 1050px; margin: 0 auto; background-color: white; padding: 30px 40px; box-sizing: border-box; border: 1px solid #ccc; display: flex; flex-direction: column; gap: 15px; page-break-after: always; overflow: hidden; margin-bottom: 20px; }
        .header-section { display: flex; align-items: center; justify-content: center; margin-bottom: 5px; position: relative; min-height: 80px; }
        .logo-placeholder { width: 120px; position: absolute; left: 0; top: 50%; transform: translateY(-50%); }
        .logo-placeholder img { max-width: 100%; height: auto; object-fit: contain; }
        .form-title { font-size: 16pt; font-weight: bold; margin: 0; text-align: center; width: 100%; }
        .check-options { display: flex; justify-content: flex-start; gap: 30px; margin-bottom: 10px; align-items: center; font-size: 9pt; padding-left: 0; margin-left: 60px; }
        .check-item { display: flex; align-items: center; gap: 8px; }
        .checkbox-box { width: 30px; height: 20px; border: 1px solid black; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.4em; line-height: 1; }
        .top-details-group { display: flex; justify-content: space-between; align-items: flex-end; padding-bottom: 5px; font-size: 9pt; gap: 20px; }
        .top-details-group > div { display: flex; align-items: flex-end; gap: 10px; }
        .top-details-group > div:nth-child(1) { flex: 25; min-width: 0; }
        .top-details-group > div:nth-child(2) { flex: 0 0 125px; }
        .top-details-group > div:nth-child(3) { flex: 0 0 125px; justify-content: flex-end; }
        .detail-label { white-space: nowrap; padding-bottom: 2px; line-height: 1.3; }
        .detail-value { width: 100%; border-bottom: 1px solid black; text-align: left; padding-bottom: 2px; text-transform: uppercase; white-space: normal; line-height: 1.3; padding-left: 10px; }
        .table-section { border: 1px solid black; display: flex; flex-direction: column; border-inline: none; font-size: 9pt; }
        .table-header { display: flex; border-bottom: 1px solid black; text-align: center; }
        .header-particulars { flex: 3; text-align: center; border-right: 1px solid black; padding: 8px 10px; }
        .header-amount { flex: 1; padding: 8px 10px; }
        .table-body { flex-grow: 1; display: flex; flex-direction: column; }
        .table-row { display: flex; flex-grow: 1; min-height: 100px; }
        .cell-particulars { flex: 3; padding: 10px; border-right: 1px solid black; white-space: pre-wrap; text-align: left; font-size: 9pt; }
        .cell-amount { flex: 1; padding: 10px; text-align: center; font-size: 9pt; }
        .table-footer { display: flex; border-top: none; font-weight: bold; background-color: #fff; }
        .footer-label-box { flex: 3; border-right: 1px solid black; padding: 10px; display: flex; justify-content: flex-end; align-items: center; }
        .footer-amount-box { flex: 1; padding: 10px; display: flex; justify-content: center; align-items: center; }
        .total-label { font-size: 9pt; margin-right: 5px; }
        .total-value { font-size: 9pt; }
        .signatures-section { display: flex; justify-content: space-between; margin-top: 5px; gap: 20px; flex-shrink: 0; align-items: stretch; }
        .signature-block { flex: 1; display: flex; flex-direction: column; align-items: center; text-align: center; font-size: 9pt; }
        .signature-label { margin-bottom: 25px; font-size: 1em; font-weight: normal; }
        .signature-wrapper { width: 80%; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; margin-bottom: 2px; flex-grow: 1; }
        .signature-name-line { width: 100%; border-bottom: 1px solid black; min-height: 1.5em; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 2px; font-weight: bold; text-transform: uppercase; white-space: normal; line-height: 1.2; }
        .signature-label-below { flex-shrink: 0; }
        .footer-notes { font-size: 7pt; flex-shrink: 0; }
        .finance-section { display: flex; justify-content: space-between; border-top: 4px double black; padding-top: 5px; gap: 30px; flex-shrink: 0; font-size: 9pt; }
        .finance-block { display: flex; flex-direction: column; gap: 3px; flex: 1; }
        .finance-title { font-weight: bold; margin-bottom: 5px; }
        .finance-item { display: flex; align-items: flex-end; gap: 10px; }
        .finance-label { white-space: nowrap; font-size: 0.9em; min-width: 60px; }
        .finance-input-line { flex-grow: 1; border-bottom: 1px solid black; min-width: 150px; min-height: 1.5em; }

        @media print {
            @page { margin: 0; size: auto; }
            body, html { width: 100%; height: 100%; margin: 0 !important; padding: 0 !important; overflow: visible !important; background-color: white; display: block; }
            .no-print, .action-buttons { display: none !important; }
            #print-area { display: block !important; }
            .print-page { width: 100% !important; height: 100vh !important; margin: 0 !important; padding: 30px 40px !important; border: none !important; box-shadow: none !important; page-break-after: always !important; }
            .print-page:last-child { page-break-after: auto !important; }
        }
    </style>
</head>
<body>

    <div id="input-section" class="no-print">
        
        <div class="left-pane">
            <h1 id="appTitle" title="Double click for Magic Import">üìù QuickRFP Generator</h1>

            <div id="magicSection" class="magic-section">
                <div class="magic-header"><span>‚ö° <b>Magic Import</b> (Paste Excel Rows)</span></div>
                <textarea id="magicInput" placeholder="Paste data row(s) here..."></textarea>
            </div>

            <div class="form-section-title">1. Payment Type</div>
            <div class="form-row">
                <div class="radio-group">
                    <label><input type="radio" name="type-opt" value="cash"> Cash Advance</label>
                    <label><input type="radio" name="type-opt" value="reimbursement"> Reimbursement</label>
                    <label><input type="radio" name="type-opt" value="pcf"> PCF(Store)</label>
                    <label><input type="radio" name="type-opt" value="external" checked> External</label>
                </div>
            </div>

            <div class="form-section-title">2. General Information</div>
            <div class="form-row">
                <div class="input-group grow-2">
                    <label>Payee Name:</label>
                    <input type="text" id="payee" placeholder="Enter full name">
                </div>
                <div class="input-group">
                    <label>Department:</label>
                    <input type="text" id="department" placeholder="Dept Code" value="SCM">
                </div>
                <div class="input-group">
                    <label>Date:</label>
                    <input type="date" id="date-input">
                </div>
            </div>

            <div class="form-row">
                <div class="input-group">
                    <label>Requested By:</label>
                    <input type="text" id="request-by" placeholder="Requestor Name">
                </div>
                <div class="input-group">
                    <label>Approved By:</label>
                    <input type="text" id="approved-by" placeholder="Approver Name">
                </div>
            </div>

            <div class="form-section-title">3. Financial Details</div>
            <div class="form-row">
                <div class="input-group">
                    <label>Particulars:</label>
                    <textarea id="particulars" rows="3" placeholder="Main description..."></textarea>
                </div>
            </div>
            <div class="form-row">
                <div class="input-group">
                    <label>Additional Details:</label>
                    <textarea id="details" rows="5" placeholder="Extra notes (PO, SI, DR, Shop)..."></textarea>
                </div>
            </div>

            <div class="form-row" style="align-items: flex-end; background: #f9f9f9; padding: 10px; border-radius: 4px; border: 1px dashed #ccc;">
                <div class="input-group grow-0-5">
                    <label>Currency:</label>
                    <div class="radio-group" style="padding: 8px; margin: 0;">
                        <label><input type="radio" name="currency-opt" value="‚Ç±" checked> (‚Ç±) Peso</label>
                        <label><input type="radio" name="currency-opt" value="$"> ($) USD</label>
                    </div>
                </div>
                <div class="input-group grow-2">
                    <label>Total Amount:</label>
                    <input type="number" id="amount" placeholder="0.00" style="font-size: 16px; font-weight: bold;">
                </div>
            </div>
            
            <div class="btn-container">
                <button id="cancelClearBtn">‚ùå Clear Form</button>
                <button id="printCurrentBtn">üñ®Ô∏è Print Current Only</button>
                
                <button id="updateBtn">üíæ Update Item</button>
                
                <button id="addBtn">‚ûï Add to Queue</button>
            </div>
        </div>

        <div class="right-pane">
            <div class="queue-header">
                <h4>üñ®Ô∏è Print Queue</h4>
            </div>
            
            <div id="queue-items-container"></div>

            <div class="queue-controls">
                <button id="clearQueueBtn">üóëÔ∏è Clear All</button>
                <button id="printQueueBtn">Print Batch</button>
            </div>
        </div>

    </div>

    <div id="print-area"></div>

    <div class="action-buttons" id="action-buttons">
        <button id="backBtn">‚Üê Edit / Add More</button>
    </div>

    <template id="rfp-template">
        <div class="print-page">
            <div class="header-section">
                <div class="logo-placeholder"><img src="logo.png" alt="Logo"></div>
                <h1 class="form-title">REQUEST FOR PAYMENT</h1>
            </div>

            <div class="check-options">
                <div class="check-item"><div class="checkbox-box box-cash"></div><span>CASH ADVANCE</span></div>
                <div class="check-item"><div class="checkbox-box box-reimburse"></div><span>REIMBURSEMENT</span></div>
                <div class="check-item"><div class="checkbox-box box-pcf"></div><span>PCF (STORE)</span></div>
                <div class="check-item"><div class="checkbox-box box-external"></div><span>EXTERNAL</span></div>
            </div>

            <div class="top-details-group">
                <div><span class="detail-label">PAYEE</span><span class="detail-value val-payee"></span></div>
                <div style="flex-grow: 0.5;"><span class="detail-label">DEP</span><span class="detail-value val-dept"></span></div>
                <div style="flex-grow: 0.5;"><span class="detail-label">DATE</span><span class="detail-value val-date"></span></div>
            </div>
            
            <div class="table-section">
                <div class="table-header">
                    <div class="header-particulars">PARTICULARS</div>
                    <div class="header-amount">AMOUNT</div>
                </div>
                <div class="table-body">
                    <div class="table-row">
                        <div class="cell-particulars val-particulars"></div>
                        <div class="cell-amount"><span class="val-amount"></span></div>
                    </div>
                </div>
                <div class="table-footer">
                    <div class="footer-label-box"><span class="total-label">TOTAL</span></div>
                    <div class="footer-amount-box"><span class="val-total total-value"></span></div>
                </div>
            </div>

            <div class="signatures-section">
                <div class="signature-block">
                    <span class="signature-label">REQUESTED BY</span>
                    <div class="signature-wrapper">
                        <span class="signature-name-line val-req"></span>
                    </div>
                    <span class="signature-label-below">Signature over Printed Name</span>
                </div>
                <div class="signature-block">
                    <span class="signature-label">APPROVED BY</span>
                    <div class="signature-wrapper">
                        <span class="signature-name-line val-app"></span>
                    </div>
                    <span class="signature-label-below">Director Head</span>
                </div>
                <div class="signature-block">
                    <span class="signature-label">RECEIVED BY</span>
                    <div class="signature-wrapper"><span class="signature-name-line"></span></div>
                    <span class="signature-label-below">Finance</span>
                </div>
            </div>

            <div class="footer-notes">
                <span>*This form must be accomplished before forwarding to Finance for processing</span><br>
                <span>Attach all the necessary supporting documents</span>
            </div>

            <div class="finance-section">
                <div class="finance-block">
                    <div class="finance-title">FINANCE</div>
                    <div class="finance-item"><span class="finance-label">AR</span><div class="finance-input-line"></div></div>
                    <div class="finance-item"><span class="finance-label">BUDGET</span><div class="finance-input-line"></div></div>
                </div>
                <div class="finance-block">
                    <div style="height: 1.5em;"></div> 
                    <div class="finance-item"><span class="finance-label">CHARGED TO</span><div class="finance-input-line"></div></div>
                    <div class="finance-item"><span class="finance-label">CONTROLLER</span><div class="finance-input-line"></div></div>
                </div>
            </div>
        </div>
    </template>

    <script>
        // Data Store
        let rfpQueue = [];
        let editingId = null; 

        // Elements
        const magicSection = document.getElementById('magicSection');
        const magicInput = document.getElementById('magicInput');
        const queueItemsContainer = document.getElementById('queue-items-container');
        const inputSection = document.getElementById('input-section');
        const printArea = document.getElementById('print-area');
        const actionButtons = document.getElementById('action-buttons');
        
        const btnAdd = document.getElementById('addBtn');
        const btnUpdate = document.getElementById('updateBtn');
        const btnPrintCurrent = document.getElementById('printCurrentBtn');
        const btnPrintBatch = document.getElementById('printQueueBtn');
        const btnClearQueue = document.getElementById('clearQueueBtn');
        const btnCancelClear = document.getElementById('cancelClearBtn');

        // Inputs
        const iPayee = document.getElementById('payee');
        const iDept = document.getElementById('department');
        const iReq = document.getElementById('request-by');
        const iApp = document.getElementById('approved-by');
        const iDate = document.getElementById('date-input');
        const iParticulars = document.getElementById('particulars');
        const iDetails = document.getElementById('details');
        const iAmount = document.getElementById('amount');
        
        // Init
        iDate.valueAsDate = new Date();
        loadQueueFromStorage(); 
        loadLocalNames();
        loadFromUrlParams();

        function loadLocalNames() {
            if(localStorage.getItem('rfp_requester')) iReq.value = localStorage.getItem('rfp_requester');
            if(localStorage.getItem('rfp_approver')) iApp.value = localStorage.getItem('rfp_approver');
        }

        function loadFromUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const setVal = (paramNames, elementId) => {
                const element = document.getElementById(elementId);
                if (!element) return;
                const names = Array.isArray(paramNames) ? paramNames : [paramNames];
                for (const name of names) {
                    if (params.has(name)) {
                        element.value = params.get(name);
                        return;
                    }
                }
            };
            setVal('payee', 'payee');
            setVal(['dept', 'department'], 'department');
            setVal(['req', 'requestor', 'requested_by'], 'request-by');
            setVal(['app', 'approver', 'approved_by'], 'approved-by');
            setVal('particulars', 'particulars');
            setVal('details', 'details');
            setVal('amount', 'amount');
            if (params.has('type')) {
                const typeVal = params.get('type').toLowerCase();
                const radio = document.querySelector(`input[name="type-opt"][value="${typeVal}"]`);
                if (radio) radio.checked = true;
            }
        }

        document.getElementById('appTitle').addEventListener('dblclick', () => {
            magicSection.style.display = magicSection.style.display === 'block' ? 'none' : 'block';
        });

        function saveQueueToStorage() { localStorage.setItem('rfpQueue', JSON.stringify(rfpQueue)); }
        function loadQueueFromStorage() {
            const saved = localStorage.getItem('rfpQueue');
            if(saved) { rfpQueue = JSON.parse(saved); updateQueueUI(); }
        }

        // --- HELPER: Get Form Data ---
        function getFormData() {
            if(!iPayee.value || !iAmount.value || !iParticulars.value) {
                alert("Please fill in Payee, Particulars, and Amount."); return null;
            }
            const type = document.querySelector('input[name="type-opt"]:checked').value;
            const currency = document.querySelector('input[name="currency-opt"]:checked').value;
            
            return {
                id: Date.now(),
                type: type,
                payee: iPayee.value.toUpperCase(),
                dept: iDept.value.toUpperCase(),
                date: iDate.value,
                req: iReq.value.toUpperCase(),
                app: iApp.value.toUpperCase(),
                particularsRaw: iParticulars.value, 
                detailsRaw: iDetails.value,
                particulars: iParticulars.value + (iDetails.value ? '\n\n' + iDetails.value : ''),
                amount: parseFloat(iAmount.value),
                currency: currency
            };
        }

        // --- HELPER: Check Duplicate ---
        function isDuplicate(data, excludeId = null) {
            return rfpQueue.some(q => 
                q.id !== excludeId &&
                q.payee === data.payee &&
                q.amount === data.amount &&
                q.particularsRaw === data.particularsRaw
            );
        }

        // --- BUTTON: ADD TO QUEUE ---
        btnAdd.addEventListener('click', () => {
            const rfpData = getFormData();
            if(!rfpData) return;

            if(isDuplicate(rfpData)) {
                if(!confirm("Duplicate Item detected (Same Payee, Amount, and Particulars). Add anyway?")) return;
            }

            rfpQueue.push(rfpData);
            finishAction();
        });

        // --- BUTTON: UPDATE ITEM ---
        btnUpdate.addEventListener('click', () => {
            const rfpData = getFormData();
            if(!rfpData) return;

            if(editingId) {
                const index = rfpQueue.findIndex(q => q.id === editingId);
                if(index !== -1) {
                    rfpData.id = editingId; // Keep original ID
                    rfpQueue[index] = rfpData;
                }
                resetToNormalMode();
                finishAction();
            }
        });

        function finishAction() {
            localStorage.setItem('rfp_requester', iReq.value);
            localStorage.setItem('rfp_approver', iApp.value);
            saveQueueToStorage(); 
            updateQueueUI();
        }

        // --- MAGIC IMPORT ---
        magicInput.addEventListener('input', () => {
            const text = magicInput.value.trim();
            if(!text) return;
            const rows = text.split('\n');
            let addedCount = 0;
            rows.forEach(row => {
                let cols = row.split('\t');
                if(cols.length < 10) return; 
                const rawAmt = cols[12] ? cols[12].replace(/[^0-9.-]+/g,"") : "0";
                let detailsText = "";
                if(cols[9]) detailsText += cols[9]; 
                if(cols[7]) detailsText += (detailsText ? "\n" : "") + "SI# " + cols[7];
                if(cols[8]) detailsText += (detailsText ? "  " : "") + "DR# " + cols[8];
                if(cols[13]) detailsText += "\n" + cols[13]; 

                const rfpData = {
                    id: Date.now() + Math.random(), 
                    type: 'external',
                    payee: (cols[6] || "").toUpperCase(),
                    dept: (cols[15] || "").toUpperCase(),
                    date: iDate.value,
                    req: (cols[11] || "").toUpperCase(),
                    app: (cols[16] || "").toUpperCase(),
                    particularsRaw: cols[1] || "",
                    detailsRaw: detailsText,
                    particulars: (cols[1] || "") + (detailsText ? '\n\n' + detailsText : ''),
                    amount: parseFloat(rawAmt) || 0,
                    currency: '‚Ç±' 
                };
                rfpQueue.push(rfpData);
                addedCount++;
            });
            if(addedCount > 0) { saveQueueToStorage(); updateQueueUI(); magicInput.value = ''; }
        });

        // --- UI & STATE UPDATES ---
        function updateQueueUI() {
            queueItemsContainer.innerHTML = '';
            
            if(rfpQueue.length === 0) {
                queueItemsContainer.innerHTML = '<div style="padding:20px; text-align:center; color:#999; font-size:12px;">Queue is empty</div>';
                btnPrintBatch.textContent = "Print Batch";
                btnPrintBatch.style.backgroundColor = "#6c757d";
            } else {
                btnPrintBatch.textContent = `Print Batch (${rfpQueue.length})`;
                btnPrintBatch.style.backgroundColor = "#28a745";
            }

            rfpQueue.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'queue-item';
                if(item.id === editingId) div.classList.add('editing');

                const fmtAmt = item.amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});

                div.innerHTML = `
                    <div class="q-header">${item.particularsRaw}</div>
                    <div class="q-sub">
                        <span>${item.payee}</span>
                        <span><b>${item.currency} ${fmtAmt}</b></span>
                    </div>
                    <div class="q-details">${item.detailsRaw}</div>
                    <div class="q-actions">
                        <span class="q-btn q-edit" onclick="editQueueItem(${item.id})">Edit</span>
                        <span class="q-btn q-remove" onclick="removeItem(${item.id})">Remove</span>
                    </div>
                `;
                queueItemsContainer.appendChild(div);
            });
        }

        window.editQueueItem = function(id) {
            const item = rfpQueue.find(q => q.id === id);
            if(!item) return;

            iPayee.value = item.payee; iDept.value = item.dept; iDate.value = item.date;
            iReq.value = item.req; iApp.value = item.app; iAmount.value = item.amount;
            iParticulars.value = item.particularsRaw || ''; 
            iDetails.value = item.detailsRaw || '';

            document.querySelector(`input[name="type-opt"][value="${item.type}"]`).checked = true;
            document.querySelector(`input[name="currency-opt"][value="${item.currency}"]`).checked = true;

            editingId = id;
            
            // SHOW UPDATE BUTTON, CHANGE ADD LABEL
            btnUpdate.style.display = "block";
            btnAdd.textContent = "‚ûï Add as New"; 
            btnAdd.style.backgroundColor = "#ffc107";
            btnAdd.style.color = "#333";
            btnCancelClear.textContent = "‚ùå Cancel Edit";
            
            updateQueueUI();
        }

        window.removeItem = function(id) {
            if(editingId === id) resetToNormalMode();
            rfpQueue = rfpQueue.filter(item => item.id !== id);
            saveQueueToStorage(); 
            updateQueueUI();
        }

        function resetToNormalMode() {
            editingId = null;
            btnUpdate.style.display = "none";
            btnAdd.textContent = "‚ûï Add to Queue";
            btnAdd.style.backgroundColor = "#ffc107";
            btnCancelClear.textContent = "‚ùå Clear Form";
        }

        function clearFormFields(clearNames) {
            iPayee.value = ''; iParticulars.value = ''; iDetails.value = ''; iAmount.value = '';
            iDate.valueAsDate = new Date();
            if(clearNames) { iReq.value = ''; iApp.value = ''; }
        }

        btnCancelClear.addEventListener('click', () => {
            if(editingId) {
                resetToNormalMode();
                updateQueueUI();
            } else {
                if(confirm("Clear everything including Names?")) clearFormFields(true); 
            }
        });

        btnClearQueue.addEventListener('click', () => {
            if(rfpQueue.length === 0) return;
            if(confirm("Delete ALL items in the queue?")) {
                rfpQueue = []; saveQueueToStorage(); updateQueueUI();
                if(editingId) resetToNormalMode();
            }
        });

        // --- PRINTING ---
        btnPrintCurrent.addEventListener('click', () => {
            if(!iPayee.value || !iAmount.value || !iParticulars.value) { alert("Fill form first."); return; }
            const rfpData = getFormData();
            if(!rfpData) return;
            generatePrintPreview([rfpData]); executePrint();
        });

        btnPrintBatch.addEventListener('click', () => {
            if(rfpQueue.length === 0) { alert("Queue is empty!"); return; }
            generatePrintPreview(rfpQueue); executePrint();
        });

        function generatePrintPreview(dataArray) {
            printArea.innerHTML = '';
            const template = document.getElementById('rfp-template');
            dataArray.forEach(data => {
                const clone = template.content.cloneNode(true);
                if(data.type === 'cash') clone.querySelector('.box-cash').textContent = '‚úì';
                if(data.type === 'reimbursement') clone.querySelector('.box-reimburse').textContent = '‚úì';
                if(data.type === 'pcf') clone.querySelector('.box-pcf').textContent = '‚úì';
                if(data.type === 'external') clone.querySelector('.box-external').textContent = '‚úì';

                clone.querySelector('.val-payee').textContent = data.payee;
                clone.querySelector('.val-dept').textContent = data.dept;
                if(data.date) {
                    const [y, m, d] = data.date.split('-');
                    clone.querySelector('.val-date').textContent = `${m}/${d}/${y}`;
                }
                clone.querySelector('.val-req').textContent = data.req;
                clone.querySelector('.val-app').textContent = data.app;
                clone.querySelector('.val-particulars').textContent = data.particulars;

                const fmtAmt = data.amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                clone.querySelector('.val-amount').textContent = `${fmtAmt}`;
                clone.querySelector('.val-total').textContent = `${data.currency} ${fmtAmt}`;
                printArea.appendChild(clone);
            });
        }

        function executePrint() {
            inputSection.style.display = 'none';
            printArea.style.display = 'block';
            actionButtons.style.display = 'block'; 
            setTimeout(() => window.print(), 500);
        }

        document.getElementById('backBtn').addEventListener('click', () => {
            inputSection.style.display = 'flex'; 
            printArea.style.display = 'none';
            actionButtons.style.display = 'none';
        });
    </script>
</body>
</html>